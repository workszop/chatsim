<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symulator Paradygmatów Chatbotów</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure MathJax
        window.MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']] // Define inline math delimiters
          },
          svg: {
            fontCache: 'global'
          }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>
    <style>
        /* Custom CSS for typing animation */
        .typing {
            border-right: 2px solid;
            animation: blink .7s steps(1) infinite;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        @keyframes blink {
            50% { border-color: transparent; }
        }
        /* Style for the details summary (accordion trigger) */
        summary { cursor: pointer; }
        /* Ensure icons align nicely with text */
        svg.inline-icon {
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        /* Ensure body takes full height for footer positioning */
        html, body {
            height: 100%;
        }
        body {
            display: flex;
            flex-direction: column;
        }
        main {
            flex-grow: 1; /* Allow main content to fill space */
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-3xl font-bold">Symulator Paradygmatów Chatbotów</h1>
            <p class="text-indigo-100 mt-1 text-sm">
                Odkryj, jak różne podejścia chatbotów radzą sobie z tym samym zapytaniem.
            </p>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6 lg:p-8 flex flex-col items-center">

        <p class="text-center text-gray-600 mb-6 max-w-3xl">
            Porównaj standardowy Duży Model Językowy (LLM), model wykorzystujący wewnętrzne rozumowanie oraz model używający Generowania Wspomaganego Wyszukiwaniem (RAG) z dostępem do określonej bazy wiedzy (np. dokumenty wewnętrzne).
        </p>

        <div class="w-full max-w-4xl flex flex-col gap-2 mb-6 bg-white p-5 rounded-lg shadow-md border border-gray-200">
            <label for="promptSelect" class="text-sm font-medium text-gray-700">Wybierz przykładowe zapytanie:</label>
            <select id="promptSelect" class="p-2 rounded border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out"></select>
            <div class="flex flex-col sm:flex-row gap-2 mt-2">
                <input id="promptInput" class="flex-1 p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" placeholder="Lub wpisz własne pytanie...">
                <button id="sendBtn" class="bg-blue-600 text-white px-6 py-2 rounded font-semibold hover:bg-blue-700 active:bg-blue-800 transition-colors duration-200 shadow-sm flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
                    </svg>
                    Wyślij
                </button>
            </div>
        </div>

        <div id="alert" class="hidden text-red-700 mb-4 font-medium p-3 bg-red-100 border border-red-300 rounded w-full max-w-4xl text-sm"></div>

        <div id="chatContainer" class="grid grid-cols-1 md:grid-cols-3 gap-5 w-full max-w-6xl">
            </div>

    </main>

    <footer class="bg-gray-800 text-gray-300 text-center p-4 mt-8 shadow-inner">
        <div class="container mx-auto text-sm">
            &copy; 2024 Symulator Chatbotów. Wszelkie prawa zastrzeżone.
        </div>
    </footer>

    <script id="questionData" type="application/json">
    {
      "questions": [
        {
          "prompt": "Wyjaśnij proces fotosyntezy",
          "llm": {
            "text": "Fotosynteza to proces biologiczny, w którym rośliny, glony i niektóre bakterie przekształcają energię świetlną, wodę i CO2 w glukozę (pokarm) oraz tlen. Jest kluczowa dla życia.",
            "tokens": 30,
            "latencyMs": 400,
            "costUsd": 0.00030
          },
          "reasoning": {
            "text": "Aby logicznie wyjaśnić fotosyntezę:\nSkłada się z dwóch głównych etapów.\n1.  **Reakcje świetlne:** Przechwytują energię słoneczną za pomocą chlorofilu, produkując ATP i NADPH.\n2.  **Cykl Calvina:** Wykorzystuje ATP i NADPH do przekształcenia CO2 w cukry (glukozę).\nTa sekwencja przekształca energię świetlną w energię chemiczną.",
            "tokens": 55,
            "latencyMs": 600,
            "costUsd": 0.00055,
            "reasoningTrace": [
              "Cel: Wyjaśnić fotosyntezę",
              "Podział: Zidentyfikować kluczowe komponenty (wejścia, proces, wyjścia)",
              "Szczegóły procesu: Podzielić na główne etapy (Reakcje świetlne, Cykl Calvina)",
              "Podsumowanie etapu 1: Energia świetlna -> Nośniki chemiczne (ATP, NADPH)",
              "Podsumowanie etapu 2: Nośniki chemiczne + CO2 -> Cukry",
              "Synteza: Połączyć podsumowania etapów w spójne wyjaśnienie przekształcenia energii."
            ]
          },
          "rag": {
            "text": "Sprawdzam wewnętrzną bazę wiedzy biologicznej:\nFotosynteza zachodzi w chloroplastach [Ref. dok.: BioKB-123]. Proces przebiega według równania $6CO_2 + 6H_2O \\xrightarrow{Światło} C_6H_{12}O_6 + 6O_2$ [Ref. dok.: SciencePrimer-Chap4]. Jest fundamentalna dla przepływu energii w ekosystemie.",
            "tokens": 48,
            "latencyMs": 780,
            "costUsd": 0.00070,
            "citations": [
              {
                "title": "Dokument wewnętrzny: BioKB-123",
                "snippet": "Sekcja dotycząca organelli komórkowych opisuje funkcję chloroplastów w fotosyntezie...",
                "url": "#"
              },
               {
                "title": "Dokument wewnętrzny: SciencePrimer-Chap4",
                "snippet": "Rozdział 4 szczegółowo opisuje równanie chemiczne i zasady przekształcania energii...",
                "url": "#"
              }
            ]
          }
        },
        {
          "prompt": "Porównaj zalety i wady samochodów elektrycznych i samochodów benzynowych.",
          "llm": {
            "text": "Pojazdy elektryczne mają zazwyczaj niższe koszty eksploatacji i zerowe emisje spalin, ale wyższe ceny zakupu i ograniczony zasięg. Samochody benzynowe są tańsze w zakupie i tankują szybciej przy większej infrastrukturze, ale mają emisje i wyższe koszty paliwa.",
            "tokens": 46,
            "latencyMs": 480,
            "costUsd": 0.00046
          },
          "reasoning": {
            "text": "Systematyczne porównanie:\n1.  **Koszt:** EV wyższe koszty początkowe, niższe eksploatacyjne (paliwo/utrzymanie). Samochody benzynowe odwrotnie.\n2.  **Środowisko:** EV zerowe emisje spalin (ale wpływ produkcji baterii). Samochody benzynowe mają bezpośrednie emisje.\n3.  **Wydajność/Wygoda:** EV ciche, szybkie przyspieszenie. Samochody benzynowe większy zasięg, szybsze tankowanie.\n4.  **Infrastruktura:** Tankowanie benzyny powszechne. Ładowanie EV rośnie, ale mniej dostępne.\n**Wniosek:** Wybór zależy od budżetu, potrzeb transportowych, priorytetów ekologicznych i lokalnej infrastruktury.",
            "tokens": 85,
            "latencyMs": 700,
            "costUsd": 0.00080,
            "reasoningTrace": [
              "Cel: Porównać pojazdy EV i benzynowe",
              "Metoda: Analiza zalet i wad",
              "Zdefiniuj kategorie: Koszt (Zakup, Eksploatacja), Środowisko, Wydajność/Wygoda, Infrastruktura",
              "Analizuj EV: Wymień zalety/wady w każdej kategorii",
              "Analizuj samochody benzynowe: Wymień zalety/wady w każdej kategorii",
              "Uporządkuj wyniki: Prezentuj odkrycia kategoria po kategorii",
              "Synteza: Dodaj podsumowanie uwzględniające kompromisy."
            ]
          },
          "rag": {
            "text": "Dostęp do wewnętrznych raportów rynkowych i technicznych:\nEV wykazują niższy TCO w ciągu 5 lat według naszej analizy [Dok: MktAnalys-Q1]. Emisje spalin są zerowe, ale kluczowa jest ocena cyklu życia baterii [Dok: TechAssess-EV7]. Samochody benzynowe zachowują przewagę w szybkości tankowania i początkowym koszcie, choć zmienność cen paliwa jest ryzykiem [Dok: MktAnalys-Q1].",
            "tokens": 68,
            "latencyMs": 820,
            "costUsd": 0.00080,
            "citations": [
              {
                "title": "Dokument wewnętrzny: MktAnalys-Q1",
                "snippet": "Analiza rynku Q1 porównująca całkowity koszt posiadania (TCO) pojazdów EV i spalinowych...",
                "url": "#"
              },
              {
                "title": "Dokument wewnętrzny: TechAssess-EV7",
                "snippet": "Dokument oceny technologicznej obejmujący emisje w cyklu życia baterii EV i recykling...",
                "url": "#"
              }
            ]
          }
        },
         {
          "prompt": "Jaka jest polityka firmy dotycząca pracy zdalnej?",
          "llm": {
            "text": "Polityka pracy zdalnej w firmach zazwyczaj określa kryteria kwalifikacji, oczekiwania dotyczące komunikacji i wydajności, wymagania dotyczące domowego biura oraz ograniczenia lokalizacji. Należy zazwyczaj zapoznać się z oficjalnym podręcznikiem HR lub dokumentami polityki w celu uzyskania szczegółów.",
            "tokens": 43,
            "latencyMs": 450,
            "costUsd": 0.00043
          },
          "reasoning": {
            "text": "Aby określić politykę pracy zdalnej:\n1.  **Zakres:** Polityka dotyczy pracowników pełnoetatowych.\n2.  **Kwalifikacje:** Wymaga zgody menedżera i odpowiedniości stanowiska (zdefiniowana lista).\n3.  **Wymagania:** Należy zachować podstawowe godziny pracy (10:00-16:00 czasu lokalnego), bezpieczny internet, dedykowane miejsce pracy.\n4.  **Lokalizacja:** Należy przebywać w zatwierdzonych krajach/stanach.\n**Podsumowanie:** Uprawnieni pracownicy mogą pracować zdalnie za zgodą menedżera, z zastrzeżeniem określonego stanowiska, konfiguracji i wymagań lokalizacyjnych.",
            "tokens": 75,
            "latencyMs": 680,
            "costUsd": 0.00070,
            "reasoningTrace": [
              "Cel: Określić politykę pracy zdalnej firmy",
              "Źródło informacji: Zakładaj dostęp do wewnętrznych zasad/logiki HR.",
              "Krok 1: Określ, do kogo odnosi się polityka (np. typy pracowników).",
              "Krok 2: Określ kryteria kwalifikacji (np. typ stanowiska, zgoda menedżera).",
              "Krok 3: Zidentyfikuj wymagania operacyjne (np. godziny, sprzęt, łączność).",
              "Krok 4: Sprawdź ograniczenia (np. ograniczenia geograficzne).",
              "Krok 5: Zsyntetyzuj odkrycia w uporządkowane podsumowanie polityki."
            ]
          },
          "rag": {
            "text": "Sprawdzam oficjalne dokumenty HR:\nPolityka pracy zdalnej [Dok: HRManual-Sec4.B] stwierdza, że kwalifikacja wymaga zgody menedżera i odpowiedniości stanowiska. Pracownicy muszą utrzymywać wyznaczone miejsce pracy i przestrzegać protokołów bezpieczeństwa określonych w [Dok: RemoteGuide-v3]. Pełne szczegóły znajdują się w Podręczniku HR.",
            "tokens": 55,
            "latencyMs": 750,
            "costUsd": 0.00075,
            "citations": [
              {
                "title": "Dokument wewnętrzny: HRManual-Sec4.B",
                "snippet": "Sekcja 4.B: Polityka pracy zdalnej, w tym kwalifikacje, proces składania wniosków i obowiązki menedżera...",
                "url": "#"
              },
              {
                "title": "Dokument wewnętrzny: RemoteGuide-v3",
                "snippet": "Wersja 3 Wytycznych pracy zdalnej, szczegółowo opisująca wymagania dotyczące miejsca pracy, protokoły bezpieczeństwa i oczekiwania komunikacyjne...",
                "url": "#"
              }
            ]
          }
        }
      ],
      "defaultAnswer": {
        "text": "Nie mam konkretnych symulowanych danych dla tego zapytania. Proszę wybrać jedno z przykładowych zapytań, aby zobaczyć porównanie.",
        "tokens": 21,
        "latencyMs": 300,
        "costUsd": 0.00015
      }
    }
    </script>

    <script>
        // --- DOM Element References ---
        // Get references to necessary HTML elements
        const qData = JSON.parse(document.getElementById('questionData').textContent); // Parse the corrected JSON
        const promptInput = document.getElementById('promptInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatContainer = document.getElementById('chatContainer');
        const alertBox = document.getElementById('alert');
        const promptSelect = document.getElementById('promptSelect');

        // --- Paradigm Definitions with Icons and Descriptions ---
        // Define the different chatbot types to simulate
        const paradigms = [
            {
                key: 'llm',
                label: 'Chat LLM',
                color: 'bg-white', // Background color class
                iconSvg: `<svg class="inline-icon w-5 h-5 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 0 0 2.25-2.25V8.25a2.25 2.25 0 0 0-2.25-2.25H6.75A2.25 2.25 0 0 0 4.5 8.25v10.5A2.25 2.25 0 0 0 6.75 21H9" /></svg>`,
                description: 'Generuje tekst bezpośrednio z obszernych danych treningowych.'
            },
            {
                key: 'reasoning',
                label: 'Chat z rozumowaniem',
                color: 'bg-green-50',
                iconSvg: `<svg class="inline-icon w-5 h-5 text-green-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.43.992a6.759 6.759 0 0 1 0 1.903c.008.378.137.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.6 6.6 0 0 1-.22.128c-.332.183-.582.495-.644.869l-.213 1.28c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.759 6.759 0 0 1 0-1.903c-.007-.378-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582.495.644-.869l.214-1.28Z" /></svg>`,
                description: 'Wykorzystuje wewnętrzne kroki logiczne lub planowanie przed odpowiedzią.'
            },
            {
                key: 'rag',
                label: 'Chat RAG',
                color: 'bg-blue-50',
                iconSvg: `<svg class="inline-icon w-5 h-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607ZM10.5 7.5v6m3-3h-6" /></svg>`,
                description: 'Najpierw wyszukuje informacje ze zdefiniowanej bazy wiedzy.'
            }
        ];

        // --- Function to Populate Sample Prompts Dropdown ---
        function populatePrompts() {
            // Clear existing options before adding new ones
            promptSelect.innerHTML = '';
            // Create and add a placeholder option
            const placeholderOption = document.createElement('option');
            placeholderOption.textContent = '-- Wybierz przykładowe zapytanie --';
            placeholderOption.value = ""; // Empty value for placeholder
            placeholderOption.disabled = true;
            placeholderOption.selected = true;
            promptSelect.appendChild(placeholderOption);

            // Add an option for each question in the data
            qData.questions.forEach(q => {
                const option = document.createElement('option');
                option.value = q.prompt; // Set the value to the prompt text
                option.textContent = q.prompt; // Set the display text
                promptSelect.appendChild(option);
            });
            console.log("Prompts populated."); // Debug log
        }


        // --- Function to Create an Individual Chat Pane ---
        function createPane(paradigm) {
            const paneDiv = document.createElement('div');
            // Apply styling for the chat pane using Tailwind classes
            paneDiv.className = `${paradigm.color} p-4 rounded-lg shadow-md flex flex-col border border-gray-200 min-h-[300px]`;
            // Set inner HTML structure for the pane (header, output area, metrics area)
            paneDiv.innerHTML = `
                <div class="flex-shrink-0"> <h2 class="font-semibold mb-1 text-lg text-gray-800">${paradigm.iconSvg}${paradigm.label}</h2>
                    <p class="text-xs text-gray-600 mb-3">${paradigm.description}</p>
                </div>
                <div class="flex-grow overflow-y-auto text-gray-700 leading-relaxed mb-2" data-output></div> <div class="flex-shrink-0 text-xs text-gray-500 mt-auto border-t border-gray-200 pt-2" data-metrics></div> `;
            return paneDiv;
        }

        // --- Function to Render Typing Output ---
        function renderOutput(outputContainer, answerData, mode) {
            outputContainer.textContent = ''; // Clear previous content
            // Split text carefully by newline, bold markdown, or LaTeX, preserving delimiters
            const segments = answerData.text.split(/(\n|\*\*.*?\*\*|\$.*?\$)/).filter(Boolean);
            let segmentIndex = 0;
            const span = document.createElement('span'); // Use a span for the typing effect
            outputContainer.appendChild(span);
            span.classList.add('typing'); // Add typing cursor class

            // Calculate delay per segment for the typing animation
            const totalDuration = answerData.latencyMs * 0.7; // Use 70% of latency for typing effect
            const delayPerSegment = Math.max(30, totalDuration / Math.max(segments.length, 1)); // Minimum 30ms delay

            // Interval timer to append segments one by one
            const intervalId = setInterval(() => {
                if (segmentIndex < segments.length) {
                    let currentSegment = segments[segmentIndex];
                    // Handle different segment types (newline, bold, LaTeX, plain text)
                    if (currentSegment === '\n') {
                        span.innerHTML += '<br>';
                    } else if (currentSegment.startsWith('**') && currentSegment.endsWith('**')) {
                        span.innerHTML += `<strong>${currentSegment.slice(2, -2)}</strong>`; // Render bold
                    } else if (currentSegment.startsWith('$') && currentSegment.endsWith('$')) {
                        span.innerHTML += currentSegment; // Keep LaTeX as is for MathJax
                    } else {
                        span.textContent += currentSegment; // Append regular text
                    }
                    segmentIndex++;
                } else {
                    // Typing finished
                    span.classList.remove('typing'); // Remove typing cursor
                    clearInterval(intervalId); // Stop the interval

                    // Add reasoning or citations sections *after* typing finishes
                    // These are added to the parent container of the output div
                    if (mode === 'reasoning' && answerData.reasoningTrace) {
                        addReasoning(outputContainer.parentNode, answerData.reasoningTrace);
                    }
                    if (mode === 'rag' && answerData.citations) {
                        addCitations(outputContainer.parentNode, answerData.citations);
                    }

                    // Trigger MathJax typesetting if available
                    if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                        MathJax.typesetPromise([outputContainer]).catch(function (err) {
                           console.error('MathJax typesetting error:', err); // Log errors
                        });
                    }
                }
            }, delayPerSegment);
        }


        // --- Function to Add Reasoning Steps Section ---
        function addReasoning(container, trace) {
            // Remove existing reasoning section first to prevent duplicates
            const existingDetails = container.querySelector('.reasoning-details');
            if (existingDetails) existingDetails.remove();

            // Create details/summary element for accordion effect
            const details = document.createElement('details');
            details.className = 'reasoning-details mt-3 text-sm border-t border-green-200 pt-2 bg-green-50 p-3 rounded'; // Styling
            // Summary text with an icon
            details.innerHTML = '<summary class="font-medium text-green-800 cursor-pointer text-base mb-1 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" /></svg>Kroki rozumowania</summary>';
            // Create ordered list for the steps
            const list = document.createElement('ol');
            list.className = 'list-decimal list-inside text-green-900 mt-1 space-y-1 pl-2';
            trace.forEach(step => {
                const item = document.createElement('li');
                item.innerHTML = step.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Support bold markdown in steps
                list.appendChild(item);
            });
            details.appendChild(list);
            // Insert the reasoning section before the metrics div
            container.insertBefore(details, container.querySelector('[data-metrics]'));
        }

        // --- Function to Add Citations Section ---
        function addCitations(container, citations) {
             // Remove existing citation section first
            const existingCitations = container.querySelector('.citation-section');
            if (existingCitations) existingCitations.remove();

            // Create div for the citation section
            const citationDiv = document.createElement('div');
            citationDiv.className = 'citation-section mt-3 space-y-2 text-xs border-t border-blue-200 pt-2 bg-blue-50 p-3 rounded'; // Styling
            // Title with an icon
            const title = document.createElement('h4');
            title.className = 'font-medium text-blue-800 mb-2 text-sm flex items-center gap-1';
            title.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>Bibliografia';
            citationDiv.appendChild(title);

            // Add each citation as a paragraph
            citations.forEach(cit => {
                const p = document.createElement('p');
                p.className = 'text-blue-900';
                // Format citation with title, snippet, and link
                p.innerHTML = `<span class="font-semibold">${cit.title}:</span> "${cit.snippet}" <a href="${cit.url || '#'}" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline hover:text-blue-800">[Link]</a>`;
                citationDiv.appendChild(p);
            });
             // Insert the citation section before the metrics div
            container.insertBefore(citationDiv, container.querySelector('[data-metrics]'));
        }


        // --- Function to Render Metrics ---
        function renderMetrics(metricsContainer, answerData) {
            // Display tokens, latency, and estimated cost
            metricsContainer.textContent = `Tokeny: ${answerData.tokens} | Opóźnienie: ${answerData.latencyMs} ms | Szac. koszt: $${answerData.costUsd.toFixed(5)}`;
        }

        // --- Main Function to Handle Sending Prompt ---
        function send() {
            console.log("Send function triggered."); // Debug log
            const promptText = promptInput.value.trim();
            // Check if prompt is empty
            if (!promptText) {
                alertBox.textContent = 'Proszę wprowadzić zapytanie lub wybrać przykład.';
                alertBox.classList.remove('hidden'); // Show alert
                // Ensure alert is red for error
                alertBox.classList.remove('bg-yellow-100', 'text-yellow-800', 'border-yellow-300');
                alertBox.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
                return;
            }

            // Find matching question data (case-insensitive comparison)
            const exactMatch = qData.questions.find(q => q.prompt.toLowerCase() === promptText.toLowerCase());
            const usingDefault = !exactMatch; // Flag if using default answer
            // Use matched data or the default answer structure
            const dataToShow = exactMatch || {
                llm: qData.defaultAnswer,
                reasoning: qData.defaultAnswer,
                rag: qData.defaultAnswer
            };

            // Clear previous results and hide any existing alert
            chatContainer.innerHTML = '';
            alertBox.classList.add('hidden');

            // Show informational alert if using the default answer set
            if (usingDefault) {
                alertBox.textContent = 'Zapytanie nie znalezione w przykładach - pokazuję domyślną symulację odpowiedzi.';
                alertBox.classList.remove('hidden');
                // Style alert as informational (yellow)
                alertBox.classList.remove('bg-red-100', 'text-red-700', 'border-red-300');
                alertBox.classList.add('bg-yellow-100', 'text-yellow-800', 'border-yellow-300');
            }

            // Create and populate panes for each defined paradigm
            paradigms.forEach(paradigm => {
                const pane = createPane(paradigm); // Create the pane structure
                chatContainer.appendChild(pane); // Add pane to the grid

                // Get references to the output and metrics divs within the new pane
                const outputDiv = pane.querySelector('[data-output]');
                const metricsDiv = pane.querySelector('[data-metrics]');
                // Get the specific answer data for this paradigm
                const answer = dataToShow[paradigm.key];

                // Use setTimeout to allow the UI to update before starting animation/metrics rendering
                // This prevents the UI from freezing briefly on potentially slow operations
                setTimeout(() => {
                    renderOutput(outputDiv, answer, paradigm.key); // Start typing animation
                    renderMetrics(metricsDiv, answer); // Display metrics
                }, 50); // Small delay (50ms)
            });

            // Reset dropdown selection if a custom prompt was entered that wasn't a sample
            if (promptSelect.value.toLowerCase() !== promptText.toLowerCase()) {
                 if(promptSelect.options.length > 0) { // Check if options exist
                    promptSelect.selectedIndex = 0; // Reset to the placeholder option
                 }
            }
        }

        // --- Event Listeners for User Interaction ---

        // Send button click
        sendBtn.addEventListener('click', send);

        // Enter key press in the input field
        promptInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission if applicable
                send();
            }
        });

        // Sample Prompt Selection Change
         promptSelect.addEventListener('change', () => {
            console.log("Dropdown changed. Selected value:", promptSelect.value); // Debug log
            if (promptSelect.value) { // Only proceed if a valid (non-placeholder) option is selected
                promptInput.value = promptSelect.value; // Update the text input
                promptInput.focus(); // Focus the text input
                send(); // Automatically send the selected prompt
            }
        });


        // --- Initialization ---
        // Populate the prompts dropdown immediately when the script runs
        populatePrompts();

    </script>
</body>
</html>
